# Iteration log for C1: Measure Identification
# Each entry records a pipeline run: what changed, what happened, what to do next.
# Retrieve any past codebook version: git show <git_commit>:prompts/c1_measure_id.yml

iterations:
  - iteration: 1
    codebook_version: "0.1.0"
    date: "2026-02-20"
    git_commit: "0ecc0db"
    model: "claude-haiku-4-5-20251001"
    stage: "s1"
    changes: >
      Initial codebook (v0.1.0). No changes from S0 draft.
    results:
      overall_pass: false
      metrics:
        - test: "I_legal_outputs"
          value: 1.0000
          threshold: 1.0000
          pass: true
        - test: "II_definition_recovery"
          value: 0.5000
          threshold: 1.0000
          pass: false
        - test: "III_example_recovery"
          value: 0.8889
          threshold: 1.0000
          pass: false
        - test: "IV_order_invariance"
          value: 0.1000
          threshold: 0.0500
          pass: false
    interpretation: >
      Model refused to classify the FISCAL_MEASURE label_definition, recognizing
      it as its own instructions echoed back and returning prose instead of JSON.
      The NOT_FISCAL_MEASURE definition was classified correctly. Test III failed
      on one borderline example (Budget Enforcement Act passage). Test IV showed
      one flip on a borderline text (text_id 4) when label order was reversed.
    decision: >
      Tighten prompt to force classification output on any input. If unsuccessful,
      try rewording the FISCAL_MEASURE label_definition.

  - iteration: 2
    codebook_version: "0.1.0"
    date: "2026-02-20"
    git_commit: "1f318cc"
    model: "claude-haiku-4-5-20251001"
    stage: "s1"
    changes: >
      Fix Test II (Definition Recovery) to use label-matching prompt per H&K spec
      instead of classify_with_codebook(). No codebook content changes; reverted
      workaround line from output_instructions. Fixed regex() namespace bug in
      parse_json_response().
    results:
      overall_pass: false
      metrics:
        - test: "I_legal_outputs"
          value: 1.0000
          threshold: 1.0000
          pass: true
        - test: "II_definition_recovery"
          value: 1.0000
          threshold: 1.0000
          pass: true
        - test: "III_example_recovery"
          value: 0.8889
          threshold: 1.0000
          pass: false
        - test: "IV_order_invariance"
          value: 0.1000
          threshold: 0.0500
          pass: false
    interpretation: >
      Tests I and II pass. Test III (Example Recovery) fails 8/9 — one example
      misclassified (NOT_FISCAL_MEASURE negative_example 2: Budget Enforcement Act
      passage classified as NOT_FISCAL_MEASURE instead of FISCAL_MEASURE). Test IV
      (Order Invariance) fails at 10% change rate (threshold <5%), with text_id 4
      flipping from NOT_FISCAL_MEASURE to FISCAL_MEASURE when class order reversed.
      Both failures are pre-existing and unrelated to the Test II fix. Test II fix
      correctly addresses H&K spec: definitions are now matched as lookup tasks
      rather than classified as passages.
    decision: >
      Investigate Test III/IV failures. Debug the 1 example recovery failure and
      10% order sensitivity before proceeding to S2.

  - iteration: 3
    codebook_version: "0.1.0"
    date: "2026-02-21"
    git_commit: "5ad9676"
    model: "claude-haiku-4-5-20251001"
    stage: "s1"
    changes: >
      Fixed codebook examples (prompts/c1_measure_id.yml): (1) Replaced
      NOT_FISCAL_MEASURE negative_example 2 — old passage (revenue projections
      baseline) was genuinely NOT_FISCAL_MEASURE with reasoning that contradicted
      its structural placement; new passage is an enacted corporate rate cut
      (Omnibus Revenue Reconciliation Act) described in forward-looking revenue
      language, a genuine FISCAL_MEASURE near-miss. (2) Tightened
      NOT_FISCAL_MEASURE negative_example 1 reasoning — removed "borderline case"
      hedging from Budget Enforcement Act passage, replaced with confident
      FISCAL_MEASURE conclusion. (3) Test III implementation changed to use
      recall-framed prompt via call_claude_api() instead of
      classify_with_codebook(), matching Test II pattern per H&K memorization
      test spec. (4) Added c1_codebook_file target (format = "file") so codebook
      YAML edits automatically invalidate downstream targets.
    results:
      overall_pass: true
      metrics:
        - test: "I_legal_outputs"
          value: 1.0000
          threshold: 1.0000
          pass: true
        - test: "II_definition_recovery"
          value: 1.0000
          threshold: 1.0000
          pass: true
        - test: "III_example_recovery"
          value: 1.0000
          threshold: 1.0000
          pass: true
        - test: "IV_order_invariance"
          value: 0.0000
          threshold: 0.0500
          pass: true
    interpretation: >
      C1 passed all S1 behavioral tests. The codebook example fix was the root
      cause of the Test III failure — the old negative example had reasoning
      that contradicted its structural label, and the model followed the
      reasoning. Test IV also now passes (0% change rate vs 10% before),
      likely because the tightened NE-1 reasoning removed the hedge language
      that made the model order-sensitive on the Budget Enforcement Act passage.
    decision: >
      Proceed to S2 (LOOCV evaluation).
